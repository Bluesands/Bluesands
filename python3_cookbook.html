<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-01-15 一 16:28 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python3 CookBook</title>
<meta name="generator" content="Org mode" />
<link rel="stylesheet" title="Standard" href="/worg/style/worg.css" type="text/css" />
<link rel="alternate stylesheet" title="Zenburn" href="/worg/style/worg-zenburn.css" type="text/css" />
<link rel="alternate stylesheet" title="Classic" href="/worg/style/worg-classic.css" type="text/css" />
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="index.html"> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Python3 CookBook</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd796a51">数据结构和算法</a>
<ul>
<li><a href="#org5bae49a">解压序列赋值给多个变量</a></li>
<li><a href="#org050c4f4">解压可迭代对象赋值给多个变量</a></li>
<li><a href="#orgf1492d8">保留组后 N 个元素</a></li>
<li><a href="#orga3f30cb">查找最大或最小的 N 个元素</a></li>
<li><a href="#org209ca5a">实现一个优先级队列</a></li>
<li><a href="#org5f522fc">字典中的键映射多个值</a></li>
<li><a href="#org0dd895e">字典排序</a></li>
<li><a href="#orged82657">字典的运算</a></li>
<li><a href="#orgae4756b">查找两个字典的相同点</a></li>
<li><a href="#org182766e">删除序列相同元素并保持顺序</a></li>
<li><a href="#org08e181a">命名切片</a></li>
<li><a href="#org424e6b0">序列中出现次数最多的元素</a></li>
<li><a href="#org4b327cd">通过某个关键字排序一个字典列表</a></li>
<li><a href="#org9b198b9">排序不支持原生比较的对象</a></li>
<li><a href="#org2ac48bb">通过某个字段将记录分组</a></li>
<li><a href="#org355068e">过滤序列元素</a></li>
</ul>
</li>
<li><a href="#orge222deb">文本与 IO</a></li>
<li><a href="#org3dc8150">数据编码和处理</a></li>
<li><a href="#org0b6d568">函数</a></li>
<li><a href="#org5377ac1">类与对象</a></li>
<li><a href="#orgb2c42f9">元编程</a>
<ul>
<li><a href="#org1ae4532">在函数上添加包装器</a></li>
<li><a href="#orgb1cc8ee">创建装饰器时保留函数元信息</a></li>
<li><a href="#org54ab9b6">解除一个装饰器</a></li>
<li><a href="#org3c50dea">定义一个带参数的装饰器</a></li>
<li><a href="#org963262d">可自定义属性的装饰器</a></li>
</ul>
</li>
<li><a href="#org013f137">模块与包</a></li>
<li><a href="#org15592bd">网络与 web 编程</a></li>
<li><a href="#org6f1a438">并发编程</a></li>
<li><a href="#org7f086ae">脚本编程与系统管理</a></li>
<li><a href="#org59d38d5">测试、调试和异常</a></li>
<li><a href="#orgcaff163">C 语言扩展</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgd796a51" class="outline-2">
<h2 id="orgd796a51">数据结构和算法</h2>
<div class="outline-text-2" id="text-orgd796a51">
<p>
Python 提供了大量的内置数据结构，包括列表、集合和字典。这里将讨论使用这些数据结构遇到的查询、排序和过滤等问题，并在集合模块 collections 当中操作菏泽写数据结构的方法。
</p>
</div>
<div id="outline-container-org5bae49a" class="outline-3">
<h3 id="org5bae49a">解压序列赋值给多个变量</h3>
<div class="outline-text-3" id="text-org5bae49a">
<p>
如何将一个包含 N 个元素的元组或序列解压赋值给 N 个变量？
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #7590db;">p</span> = <span style="color: #4f97d7;">(</span><span style="color: #a45bad;">4</span>, <span style="color: #a45bad;">5</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">x</span>, <span style="color: #7590db;">y</span> = p
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>x, y<span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">data</span> = <span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'ACEM'</span>, <span style="color: #a45bad;">50</span>, <span style="color: #a45bad;">91</span>.<span style="color: #a45bad;">1</span>, <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2012</span>, <span style="color: #a45bad;">12</span>, <span style="color: #a45bad;">21</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">name</span>, <span style="color: #7590db;">shares</span>, <span style="color: #7590db;">price</span>, <span style="color: #7590db;">date</span> = data
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>name, shares, price, date<span style="color: #4f97d7;">)</span>

name, shares, price, <span style="color: #4f97d7;">(</span>year, mon, day<span style="color: #4f97d7;">)</span> = data
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>name, shares, price, year, mon, day<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
4 5
ACEM 50 91.1 (2012, 12, 21)
ACEM 50 91.1 2012 12 21

</pre>
<p>
这种解压赋值可以用在任何可迭代对象上面，而不仅仅是列表或元组。包括字符串，文件对象，迭代器和生成器。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #7590db;">a</span>, <span style="color: #7590db;">b</span>, <span style="color: #7590db;">c</span>, <span style="color: #7590db;">d</span>, <span style="color: #7590db;">e</span> = <span style="color: #2d9574;">'Hello'</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a, b, c, d, e<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">a</span>, <span style="color: #7590db;">b</span>, <span style="color: #7590db;">c</span>, <span style="color: #7590db;">d</span> = <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">4</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a, b, c, d<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
H e l l o
0 1 2 3

</pre>
<p>
如果只需要部分值，可用任意不被用到的变量名去占位。
</p>
</div>
</div>

<div id="outline-container-org050c4f4" class="outline-3">
<h3 id="org050c4f4">解压可迭代对象赋值给多个变量</h3>
<div class="outline-text-3" id="text-org050c4f4">
<p>
如果一个可迭代对象的元素个数超过变量个数，会抛出一个 ValueError。则如何从这个可迭代对象中解压出 N 个元素呢？
python 的星号表达式可以解决这个问题。
</p>
<div class="org-src-container">
<pre class="src src-python">a, b, *<span style="color: #7590db;">c</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">3</span>, <span style="color: #a45bad;">4</span>, <span style="color: #a45bad;">5</span><span style="color: #4f97d7;">]</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a, b, c<span style="color: #4f97d7;">)</span>

a, b, *<span style="color: #7590db;">c</span> = <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">10</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a, b, c<span style="color: #4f97d7;">)</span>

a, *<span style="color: #7590db;">b</span>, <span style="color: #7590db;">c</span> = <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">10</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a, b, c<span style="color: #4f97d7;">)</span>

*<span style="color: #7590db;">a</span>, <span style="color: #7590db;">b</span>, <span style="color: #7590db;">c</span> = <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">10</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a, b, c, end=<span style="color: #2d9574;">''</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
1 2 [3, 4, 5]
0 1 [2, 3, 4, 5, 6, 7, 8, 9]
0 [1, 2, 3, 4, 5, 6, 7, 8] 9
[0, 1, 2, 3, 4, 5, 6, 7] 8 9

</pre>
<p>
注意：星号对应的变量永远是列表类型。扩展的迭代解压语法是专门为解压不确定个数或任意个数元素的可迭代对象而设 concat 计的。通常这些可迭代对象的元素结构有确定的规则，特别是，星号表达式在迭代元素为可变长元组的序列时是很有用的。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #7590db;">records</span> = <span style="color: #4f97d7;">[</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'foo'</span>, <span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>, <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'bar'</span>, <span style="color: #2d9574;">'hello'</span><span style="color: #bc6ec5;">)</span>, <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'foo'</span>, <span style="color: #a45bad;">3</span>, <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">]</span>


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">do_foo</span><span style="color: #4f97d7;">(</span>x, y<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'foo'</span>, x, y<span style="color: #4f97d7;">)</span>


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">do_bar</span><span style="color: #4f97d7;">(</span>s<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'bar'</span>, s<span style="color: #4f97d7;">)</span>


<span style="color: #4f97d7; font-weight: bold;">for</span> tag, *args <span style="color: #4f97d7; font-weight: bold;">in</span> records:
    <span style="color: #4f97d7; font-weight: bold;">if</span> tag == <span style="color: #2d9574;">'foo'</span>:
        do_foo<span style="color: #4f97d7;">(</span>*args<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">elif</span> tag == <span style="color: #2d9574;">'bar'</span>:
        do_bar<span style="color: #4f97d7;">(</span>*args<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
foo 1 2
bar hello
foo 3 4

</pre>

<p>
星号解压语法在字符串操作的时候也会很有用，比如分割字符串：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #7590db;">line</span> = <span style="color: #2d9574;">'nobody:*:-2:-2:Unprivileged User:/var/empty:/usr/bin/false'</span>
uname, *<span style="color: #7590db;">fields</span>, <span style="color: #7590db;">homedir</span>, <span style="color: #7590db;">sh</span> = line.split<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">':'</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>uname, fields, homedir, sh<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
nobody ['*', '-2', '-2', 'Unprivileged User'] /var/empty /usr/bin/false

</pre>

<p>
正克隆到 '/tmp/yaourt-tmp-qiang/aur-redi+RESULTS:
</p>
<pre class="example">
nobody ['*', '-2', '-2', 'Unprivileged User'] /var/empty /usr/bin/false

</pre>
</div>
</div>

<div id="outline-container-orgf1492d8" class="outline-3">
<h3 id="orgf1492d8">保留组后 N 个元素</h3>
<div class="outline-text-3" id="text-orgf1492d8">
<p>
在迭代操作或者其他操作时，怎样只保留最后有限几个元素的历史记录？保留有限历史记录正是 collections.deque 大显身手的时候。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> collections <span style="color: #4f97d7; font-weight: bold;">import</span> deque


<span style="color: #7590db;">file_lines</span> = <span style="color: #2d9574;">'''Python is powerful... and fast;</span>
<span style="color: #2d9574;">plays well with others;</span>
<span style="color: #2d9574;">runs everywhere;</span>
<span style="color: #2d9574;">is friendly &amp; easy to learn;</span>
<span style="color: #2d9574;">is Open.</span>
<span style="color: #2d9574;">These are some of the reasons people who use Python would rather not use anything else.</span>

<span style="color: #2d9574;">Python can be easy to pick up whether you're a first time programmer</span>
<span style="color: #2d9574;">or you're experienced with other languages.</span>
<span style="color: #2d9574;">The following pages are a useful first step to get on your way</span>
<span style="color: #2d9574;">writing programs with Python!</span>

<span style="color: #2d9574;">The community hosts conferences and meetups, collaborates on code,</span>
<span style="color: #2d9574;">and much more. Python's documentation will help you along the way,</span>
<span style="color: #2d9574;">and the mailing lists will keep you in touch.</span>

<span style="color: #2d9574;">Conferences and Workshops</span>
<span style="color: #2d9574;">Python Documentation</span>
<span style="color: #2d9574;">Mailing Lists and IRC channels'''</span>


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">search</span><span style="color: #4f97d7;">(</span>lines, pattern, history=<span style="color: #a45bad;">5</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">previous_lines</span> = deque<span style="color: #4f97d7;">(</span>maxlen=history<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> line <span style="color: #4f97d7; font-weight: bold;">in</span> lines:
        <span style="color: #4f97d7; font-weight: bold;">if</span> pattern <span style="color: #4f97d7; font-weight: bold;">in</span> line:
            <span style="color: #4f97d7; font-weight: bold;">yield</span> line, previous_lines
        previous_lines.append<span style="color: #4f97d7;">(</span>line<span style="color: #4f97d7;">)</span>


<span style="color: #4f97d7; font-weight: bold;">for</span> line, prevlines <span style="color: #4f97d7; font-weight: bold;">in</span> search<span style="color: #4f97d7;">(</span>file_lines.split<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'\n'</span><span style="color: #bc6ec5;">)</span>, <span style="color: #2d9574;">'Python'</span>, <span style="color: #a45bad;">5</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">for</span> pline <span style="color: #4f97d7; font-weight: bold;">in</span> prevlines:
        <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>pline<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>line<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'-'</span> * <span style="color: #a45bad;">15</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Python is powerful... and fast;
---------------
Python is powerful... and fast;
plays well with others;
runs everywhere;
is friendly &amp; easy to learn;
is Open.
These are some of the reasons people who use Python would rather not use anything else.
---------------
runs everywhere;
is friendly &amp; easy to learn;
is Open.
These are some of the reasons people who use Python would rather not use anything else.

Python can be easy to pick up whether you're a first time programmer
---------------
These are some of the reasons people who use Python would rather not use anything else.

Python can be easy to pick up whether you're a first time programmer
or you're experienced with other languages.
The following pages are a useful first step to get on your way
writing programs with Python!
---------------
or you're experienced with other languages.
The following pages are a useful first step to get on your way
writing programs with Python!

The community hosts conferences and meetups, collaborates on code,
and much more. Python's documentation will help you along the way,
---------------
The community hosts conferences and meetups, collaborates on code,
and much more. Python's documentation will help you along the way,
and the mailing lists will keep you in touch.

Conferences and Workshops
Python Documentation
---------------
</pre>

<p>
其中 collections.deque 是一个双端队列.
我们在写查询元素的代码时，通常会使用包含 yield 表达式的生成器函数，也就是我们上面代码示例。这样可以将搜索过程和使用搜索代码解耦。使用 deque(maxlen=N)构造函数会新建一个固定大小的队列，当新的元素加入并且这个队列已满的时候，最老的元素会自动被移除。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> collections <span style="color: #4f97d7; font-weight: bold;">import</span> deque
<span style="color: #7590db;">q</span> = deque<span style="color: #4f97d7;">(</span>maxlen=<span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
q.append<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
q.append<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">2</span><span style="color: #4f97d7;">)</span>
q.append<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q<span style="color: #4f97d7;">)</span>
q.append<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">4</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q<span style="color: #4f97d7;">)</span>
q.append<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">5</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q, end=<span style="color: #2d9574;">''</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
deque([1, 2, 3], maxlen=3)
deque([2, 3, 4], maxlen=3)
deque([3, 4, 5], maxlen=3)

</pre>
<p>
使用 deque 队列方案会更优雅且运行更快。一般 deque 类可以被用在任何你只需要一个简单队列数据结构的场合。如果你不设置最大队列大小，那么就会得到一个无线大小队列，你可以在队列的两端执行添加和弹出元素的操作，其具体包含那么方法如下：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> collections <span style="color: #4f97d7; font-weight: bold;">import</span> deque

<span style="color: #7590db;">q</span> = deque<span style="color: #4f97d7;">(</span>maxlen=<span style="color: #a45bad;">20</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#23614;&#37096;&#28155;&#21152;&#25968;&#25454;</span>
q.append<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
q.append<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">2</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q<span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#22836;&#37096;&#28155;&#21152;&#25968;&#25454;</span>
q.appendleft<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q<span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#23614;&#37096;&#25193;&#23637;&#21487;&#36845;&#20195;&#23545;&#35937;</span>
q.extend<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">4</span>, <span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q<span style="color: #4f97d7;">)</span>
q.extend<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">range</span><span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q<span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#22836;&#37096;&#25193;&#23637;&#21487;&#36845;&#20195;&#23545;&#35937;</span>
q.extendleft<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">6</span>, <span style="color: #a45bad;">7</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q<span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#23614;&#37096;&#31227;&#38500;</span>
q.pop<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q<span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#22836;&#37096;&#31227;&#38500;</span>
q.popleft<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q<span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#32479;&#35745;&#20803;&#32032;&#20986;&#29616;&#30340;&#20010;&#25968;</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q.count<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">index &#26816;&#32034;</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q.index<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#25351;&#23450;&#20301;&#32622;&#25554;&#20837;</span>
q.insert<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">13</span>, <span style="color: #a45bad;">56</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q, end=<span style="color: #2d9574;">''</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">clear &#28165;&#31354;&#38431;&#21015;</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">copy &#22797;&#21046;&#38431;&#21015;</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">remove &#31227;&#38500;&#38431;&#21015;&#20013;&#25351;&#23450;&#20540;</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">reverse &#32763;&#36716;&#38431;&#21015;</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">rotate &#26059;&#36716;&#38431;&#21015;</span>
</pre>
</div>

<pre class="example">
deque([1, 2], maxlen=20)
deque([3, 1, 2], maxlen=20)
deque([3, 1, 2, 4, 5], maxlen=20)
deque([3, 1, 2, 4, 5, 0, 1, 2], maxlen=20)
deque([7, 6, 3, 1, 2, 4, 5, 0, 1, 2], maxlen=20)
deque([7, 6, 3, 1, 2, 4, 5, 0, 1], maxlen=20)
deque([6, 3, 1, 2, 4, 5, 0, 1], maxlen=20)
2
3
deque([6, 3, 1, 2, 4, 5, 0, 1, 56], maxlen=20)
</pre>
</div>
</div>

<div id="outline-container-orga3f30cb" class="outline-3">
<h3 id="orga3f30cb">查找最大或最小的 N 个元素</h3>
<div class="outline-text-3" id="text-orga3f30cb">
<p>
如何从一个集合中获得最大或最小 N 个元素列表？
heapq 模块有两个函数：nlargest()和 nsmallest()可以完美解决这两个问题。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> heapq

<span style="color: #7590db;">nums</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">8</span>, <span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">23</span>, <span style="color: #a45bad;">7</span>, -<span style="color: #a45bad;">4</span>, <span style="color: #a45bad;">18</span>, <span style="color: #a45bad;">23</span>, <span style="color: #a45bad;">42</span>, <span style="color: #a45bad;">37</span>, <span style="color: #a45bad;">2</span><span style="color: #4f97d7;">]</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>heapq.nlargest<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">3</span>, nums<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>heapq.nsmallest<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">3</span>, nums<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
[42, 37, 23]
[-4, 1, 2]

</pre>
<p>
两个函数都能接受一个关键字参数，用于复杂的数据结构中：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> heapq
<span style="color: #4f97d7; font-weight: bold;">from</span> pprint <span style="color: #4f97d7; font-weight: bold;">import</span> pprint

<span style="color: #7590db;">portfolio</span> = <span style="color: #4f97d7;">[</span><span style="color: #bc6ec5;">{</span>
    <span style="color: #2d9574;">'name'</span>: <span style="color: #2d9574;">'IBM'</span>,
    <span style="color: #2d9574;">'shares'</span>: <span style="color: #a45bad;">100</span>,
    <span style="color: #2d9574;">'price'</span>: <span style="color: #a45bad;">91</span>.<span style="color: #a45bad;">1</span>
<span style="color: #bc6ec5;">}</span>, <span style="color: #bc6ec5;">{</span>
    <span style="color: #2d9574;">'name'</span>: <span style="color: #2d9574;">'AAPL'</span>,
    <span style="color: #2d9574;">'shares'</span>: <span style="color: #a45bad;">50</span>,
    <span style="color: #2d9574;">'price'</span>: <span style="color: #a45bad;">543</span>.<span style="color: #a45bad;">22</span>
<span style="color: #bc6ec5;">}</span>, <span style="color: #bc6ec5;">{</span>
    <span style="color: #2d9574;">'name'</span>: <span style="color: #2d9574;">'FB'</span>,
    <span style="color: #2d9574;">'shares'</span>: <span style="color: #a45bad;">200</span>,
    <span style="color: #2d9574;">'price'</span>: <span style="color: #a45bad;">21</span>.<span style="color: #a45bad;">09</span>
<span style="color: #bc6ec5;">}</span>, <span style="color: #bc6ec5;">{</span>
    <span style="color: #2d9574;">'name'</span>: <span style="color: #2d9574;">'HPQ'</span>,
    <span style="color: #2d9574;">'shares'</span>: <span style="color: #a45bad;">35</span>,
    <span style="color: #2d9574;">'price'</span>: <span style="color: #a45bad;">31</span>.<span style="color: #a45bad;">75</span>
<span style="color: #bc6ec5;">}</span>, <span style="color: #bc6ec5;">{</span>
    <span style="color: #2d9574;">'name'</span>: <span style="color: #2d9574;">'YHOO'</span>,
    <span style="color: #2d9574;">'shares'</span>: <span style="color: #a45bad;">45</span>,
    <span style="color: #2d9574;">'price'</span>: <span style="color: #a45bad;">16</span>.<span style="color: #a45bad;">35</span>
<span style="color: #bc6ec5;">}</span>, <span style="color: #bc6ec5;">{</span>
    <span style="color: #2d9574;">'name'</span>: <span style="color: #2d9574;">'ACME'</span>,
    <span style="color: #2d9574;">'shares'</span>: <span style="color: #a45bad;">75</span>,
    <span style="color: #2d9574;">'price'</span>: <span style="color: #a45bad;">115</span>.<span style="color: #a45bad;">65</span>
<span style="color: #bc6ec5;">}</span><span style="color: #4f97d7;">]</span>

<span style="color: #7590db;">cheap</span> = heapq.nsmallest<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">3</span>, portfolio, key=<span style="color: #4f97d7; font-weight: bold;">lambda</span> x: x<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'price'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">expensive</span> = heapq.nlargest<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">3</span>, portfolio, key=<span style="color: #4f97d7; font-weight: bold;">lambda</span> x: x<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'price'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
pprint<span style="color: #4f97d7;">(</span>cheap<span style="color: #4f97d7;">)</span>
pprint<span style="color: #4f97d7;">(</span>expensive<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
[{'name': 'YHOO', 'price': 16.35, 'shares': 45},
 {'name': 'FB', 'price': 21.09, 'shares': 200},
 {'name': 'HPQ', 'price': 31.75, 'shares': 35}]
[{'name': 'AAPL', 'price': 543.22, 'shares': 50},
 {'name': 'ACME', 'price': 115.65, 'shares': 75},
 {'name': 'IBM', 'price': 91.1, 'shares': 100}]

</pre>
<p>
key 的排序可以参考 sorted 函数的 key，都是可以采用匿名函数进行复杂排序的。
</p>

<p>
如果你想在一个集合中查找最小或最大 N 个元素，并且 N 小于集合元素数量，那么这些函数提供了很好的性能。因为在底层实现里面，首先会先将集合数据进行堆排序后放入一个列表中：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> heapq

<span style="color: #7590db;">nums</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">8</span>, <span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">23</span>, <span style="color: #a45bad;">7</span>, -<span style="color: #a45bad;">4</span>, <span style="color: #a45bad;">18</span>, <span style="color: #a45bad;">23</span>, <span style="color: #a45bad;">42</span>, <span style="color: #a45bad;">37</span>, <span style="color: #a45bad;">2</span><span style="color: #4f97d7;">]</span>
heapq.heapify<span style="color: #4f97d7;">(</span>nums<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>nums<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>heapq.heappop<span style="color: #bc6ec5;">(</span>nums<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>heapq.heappop<span style="color: #bc6ec5;">(</span>nums<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
uprint<span style="color: #4f97d7;">(</span>heapq.heappop<span style="color: #bc6ec5;">(</span>nums<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
堆数据结构最重要的特征是 heap[0]永远是最小的元素。并且剩余的元素都可以很容易通过调用 heapq.heappop()方法得到，该方法会先将地一个元素弹出，然后用下一个最小元素来取代被弹出的元素（这种操作时间复杂度仅仅是 O(logN)，N 是堆大小）。堆数据结构的实现是一个很有趣并且值得深入学习的东西，基本上只要是数据结构和算法书籍里都会提到。heapq 模块官方提供了详细的堆数据结构底层实现细节，可以参考研究一下。对于提高 python 是很有帮助的。
</p>
</div>
</div>

<div id="outline-container-org209ca5a" class="outline-3">
<h3 id="org209ca5a">实现一个优先级队列</h3>
<div class="outline-text-3" id="text-org209ca5a">
<p>
怎样实现一个按优先级排序的队列？并且在这个队列上每次 pop 操作总是返回优先级最高的那个元素？一下是利用 heapq 模块实现了一个简单的优先级队列：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> heapq


<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">PriorityQueue</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">object</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">__init__</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span><span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">self</span>._queue = <span style="color: #4f97d7;">[]</span>
        <span style="color: #4f97d7; font-weight: bold;">self</span>._index = <span style="color: #a45bad;">0</span>

    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">push</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, item, priority<span style="color: #4f97d7;">)</span>:
        heapq.heappush<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>._queue, <span style="color: #bc6ec5;">(</span>-priority, <span style="color: #4f97d7; font-weight: bold;">self</span>._index, item<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">self</span>._index += <span style="color: #a45bad;">1</span>

    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">pop</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span><span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">return</span> heapq.heappop<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>._queue<span style="color: #4f97d7;">)[</span>-<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>


<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">Item</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">object</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">__init__</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, name<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">self</span>.name = name

    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">__repr__</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span><span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">'Item({!r})'</span>.<span style="color: #4f97d7;">format</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>.name<span style="color: #4f97d7;">)</span>


<span style="color: #7590db;">q</span> = PriorityQueue<span style="color: #4f97d7;">()</span>
q.push<span style="color: #4f97d7;">(</span>Item<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'foo'</span><span style="color: #bc6ec5;">)</span>, <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
q.push<span style="color: #4f97d7;">(</span>Item<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'bar'</span><span style="color: #bc6ec5;">)</span>, <span style="color: #a45bad;">5</span><span style="color: #4f97d7;">)</span>
q.push<span style="color: #4f97d7;">(</span>Item<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'spam'</span><span style="color: #bc6ec5;">)</span>, <span style="color: #a45bad;">4</span><span style="color: #4f97d7;">)</span>
q.push<span style="color: #4f97d7;">(</span>Item<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'grok'</span><span style="color: #bc6ec5;">)</span>, <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> _ <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">4</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>q.pop<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Item('bar')
Item('spam')
Item('foo')
Item('grok')

</pre>
<p>
第一个 pop()操作返回优先级最高的元素。另外注意到如果两个有着相同优先级的元素(foo 和 grok），pop 操作按照它们传入到队列的顺序返回。这一节主要关注 heapq 模块。函数 heapq.heappush()和 heapq.heappop()分别在队列_queue 上插入和删除第一个元素，并且队列_queue 保证第一个元素拥有最高优先级。heappop()总是返回最小元素，这就保证队列 pop 操作返回正确元素的关键。由于 push 和 pop 操作时间复杂度为 O(logN)，其中 N 是堆的大小，因此就算是 N 很大的时候它们运行速度也依旧很快。在上面代码中，队列包含了一个(-priority, index, item)的元组。优先级为负数的目的是使得元素按照优先级从高到底排序。
index 变量的作用是保证同等优先级元素的正确顺序。而且，index 变量也在相同优先级元素比较的时候起到重要作用。如果想在多线程中使用同一个队列，那么需要增加适当的锁和信号量机制。
</p>
</div>
</div>

<div id="outline-container-org5f522fc" class="outline-3">
<h3 id="org5f522fc">字典中的键映射多个值</h3>
<div class="outline-text-3" id="text-org5f522fc">
<p>
怎样实现一个键对应多个值的字典（multidict）？一个字典就是一个键对应一个单值的映射。如果想要一个键映射多个值，就需要将多个值放入容器中。可以使用 collection 模块的 defaultdict 来构建这样的字典。defaultdict 的一个特征是会自动初始化每个 key 刚开始对应的值。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> collections <span style="color: #4f97d7; font-weight: bold;">import</span> defaultdict
<span style="color: #4f97d7; font-weight: bold;">from</span> pprint <span style="color: #4f97d7; font-weight: bold;">import</span> pprint

<span style="color: #7590db;">d</span> = defaultdict<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">list</span><span style="color: #4f97d7;">)</span>
d<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'a'</span><span style="color: #4f97d7;">]</span>.append<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
d<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'a'</span><span style="color: #4f97d7;">]</span>.append<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">2</span><span style="color: #4f97d7;">)</span>
d<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'b'</span><span style="color: #4f97d7;">]</span>.append<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">4</span><span style="color: #4f97d7;">)</span>
pprint<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">dict</span><span style="color: #bc6ec5;">(</span>d<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">d</span> = defaultdict<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">set</span><span style="color: #4f97d7;">)</span>
d<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'a'</span><span style="color: #4f97d7;">]</span>.add<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
d<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'a'</span><span style="color: #4f97d7;">]</span>.add<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">2</span><span style="color: #4f97d7;">)</span>
d<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'b'</span><span style="color: #4f97d7;">]</span>.add<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">4</span><span style="color: #4f97d7;">)</span>
pprint<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">dict</span><span style="color: #bc6ec5;">(</span>d<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">d</span> = defaultdict<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">dict</span><span style="color: #4f97d7;">)</span>
d<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'a1'</span><span style="color: #4f97d7;">][</span><span style="color: #2d9574;">'a2'</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">2</span><span style="color: #4f97d7;">]</span>
d<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'a1'</span><span style="color: #4f97d7;">][</span><span style="color: #2d9574;">'a3'</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">3</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">d</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'b'</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">2</span><span style="color: #4f97d7;">)</span>
pprint<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">dict</span><span style="color: #bc6ec5;">(</span>d<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
{'a': [1, 2], 'b': [4]}
{'a': {1, 2}, 'b': {4}}
{'a1': {'a2': [1, 2], 'a3': [2, 3]}, 'b': (1, 2)}

</pre>
<p>
想对于 dict 自带的 setdefault()方便很多。
</p>
</div>
</div>

<div id="outline-container-org0dd895e" class="outline-3">
<h3 id="org0dd895e">字典排序</h3>
<div class="outline-text-3" id="text-org0dd895e">
<p>
创建一个字典并且在迭代或序列化这个字典的时候能够控制元素的顺序。为了能控制一个字典中元素的顺序，可以使用 collections 模块中 OrderedDict 类。在迭代操作的时候它会保持元素被插入时的顺序。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> collections <span style="color: #4f97d7; font-weight: bold;">import</span> OrderedDict

<span style="color: #7590db;">d</span> = OrderedDict<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">d</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'foo'</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">1</span>
<span style="color: #7590db;">d</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'bar'</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">2</span>
<span style="color: #7590db;">d</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'spam'</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">3</span>
<span style="color: #7590db;">d</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'grok'</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">4</span>

<span style="color: #4f97d7; font-weight: bold;">for</span> k, v <span style="color: #4f97d7; font-weight: bold;">in</span> d.items<span style="color: #4f97d7;">()</span>:
    <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>k, v<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
foo 1
bar 2
spam 3
grok 4

</pre>
<p>
OrderedDict 内部维护着一个根据键插入顺序的双向链表。每次当一个新的元素插入进来的时候，它会被放到链表的尾部。对于一个已经存在的键的重复赋值不会改变键的顺序。需要注意的是，一个 OrderedDict 的大小是一个普通字典的两倍，因为它内部维护着另外一个链表。所以如果需要构建大量 OrderedDict 实例的数据结构时就得考虑一下内存消耗的影响。
</p>
</div>
</div>

<div id="outline-container-orged82657" class="outline-3">
<h3 id="orged82657">字典的运算</h3>
<div class="outline-text-3" id="text-orged82657">
<p>
怎样在数据字典中执行一些计算操作（比如求最小值、最大值、排序等）？为了对字典值执行计算，通常需要使用 zip()函数先将键和值反转过来。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> operator

<span style="color: #7590db;">prices</span> = <span style="color: #4f97d7;">{</span>
    <span style="color: #2d9574;">'ACME'</span>: <span style="color: #a45bad;">45</span>.<span style="color: #a45bad;">23</span>,
    <span style="color: #2d9574;">'AAPL'</span>: <span style="color: #a45bad;">612</span>.<span style="color: #a45bad;">78</span>,
    <span style="color: #2d9574;">'IBM'</span>: <span style="color: #a45bad;">205</span>.<span style="color: #a45bad;">55</span>,
    <span style="color: #2d9574;">'HPQ'</span>: <span style="color: #a45bad;">37</span>.<span style="color: #a45bad;">20</span>,
    <span style="color: #2d9574;">'FB'</span>: <span style="color: #a45bad;">10</span>.<span style="color: #a45bad;">75</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #7590db;">max_price</span> = <span style="color: #4f97d7;">max</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>prices.values<span style="color: #2d9574;">()</span>, prices.keys<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">min_price</span> = <span style="color: #4f97d7;">min</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>prices.values<span style="color: #2d9574;">()</span>, prices.keys<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>max_price, min_price<span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">prices_sorted</span> = <span style="color: #4f97d7;">sorted</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">zip</span><span style="color: #bc6ec5;">(</span>prices.values<span style="color: #2d9574;">()</span>, prices.keys<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>prices_sorted<span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">prices_sorted_v2</span> = <span style="color: #4f97d7;">sorted</span><span style="color: #4f97d7;">(</span>prices.items<span style="color: #bc6ec5;">()</span>, key=<span style="color: #4f97d7; font-weight: bold;">lambda</span> x: x<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>prices_sorted_v2<span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">prices_sorted_v3</span> = <span style="color: #4f97d7;">sorted</span><span style="color: #4f97d7;">(</span>prices.items<span style="color: #bc6ec5;">()</span>, key=operator.itemgetter<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>prices_sorted_v3<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
(612.78, 'AAPL') (10.75, 'FB')
[(10.75, 'FB'), (37.2, 'HPQ'), (45.23, 'ACME'), (205.55, 'IBM'), (612.78, 'AAPL')]
[('FB', 10.75), ('HPQ', 37.2), ('ACME', 45.23), ('IBM', 205.55), ('AAPL', 612.78)]
[('FB', 10.75), ('HPQ', 37.2), ('ACME', 45.23), ('IBM', 205.55), ('AAPL', 612.78)]

</pre>

<p>
上述共有四种方法实现了对字典的排序，推荐使用最后两种。
</p>
</div>
</div>

<div id="outline-container-orgae4756b" class="outline-3">
<h3 id="orgae4756b">查找两个字典的相同点</h3>
<div class="outline-text-3" id="text-orgae4756b">
<p>
怎样在两个字典中寻找相同点，比如相同的键，相同的值等等？
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #7590db;">a</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'x'</span>: <span style="color: #a45bad;">1</span>, <span style="color: #2d9574;">'y'</span>: <span style="color: #a45bad;">2</span>, <span style="color: #2d9574;">'z'</span>: <span style="color: #a45bad;">3</span><span style="color: #4f97d7;">}</span>
<span style="color: #7590db;">b</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">'w'</span>: <span style="color: #a45bad;">10</span>, <span style="color: #2d9574;">'x'</span>: <span style="color: #a45bad;">11</span>, <span style="color: #2d9574;">'y'</span>: <span style="color: #a45bad;">2</span><span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">find keys in common</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a.keys<span style="color: #bc6ec5;">()</span> &amp; b.keys<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">find keys in a that are not in b</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a.keys<span style="color: #bc6ec5;">()</span> - b.keys<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">find (key, value) pairs in common</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a.items<span style="color: #bc6ec5;">()</span> &amp; b.items<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">create new dict filter from a or b</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">{</span>key:a<span style="color: #2d9574;">[</span>key<span style="color: #2d9574;">]</span> <span style="color: #4f97d7; font-weight: bold;">for</span> key <span style="color: #4f97d7; font-weight: bold;">in</span> a.keys<span style="color: #2d9574;">()</span> - <span style="color: #2d9574;">{</span><span style="color: #2d9574;">'z'</span>, <span style="color: #2d9574;">'w'</span><span style="color: #2d9574;">}</span><span style="color: #bc6ec5;">}</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
{'x', 'y'}
{'z'}
{('y', 2)}
{'x': 1, 'y': 2}

</pre>
</div>
</div>

<div id="outline-container-org182766e" class="outline-3">
<h3 id="org182766e">删除序列相同元素并保持顺序</h3>
<div class="outline-text-3" id="text-org182766e">
<p>
怎样在一个序列上面保持元素顺序的同时消除重复的值？如果序列上的值都是 hashable 类型，那么可以很简单的利用集合或者生成器来解决这个问题。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">dedupe</span><span style="color: #4f97d7;">(</span>items<span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">seen</span> = <span style="color: #4f97d7;">set</span><span style="color: #4f97d7;">()</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> item <span style="color: #4f97d7; font-weight: bold;">in</span> items:
        <span style="color: #4f97d7; font-weight: bold;">if</span> item <span style="color: #4f97d7; font-weight: bold;">not</span> <span style="color: #4f97d7; font-weight: bold;">in</span> seen:
            <span style="color: #4f97d7; font-weight: bold;">yield</span> item
            seen.add<span style="color: #4f97d7;">(</span>item<span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">a</span>=  <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">5</span>, <span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">9</span>, <span style="color: #a45bad;">5</span>, <span style="color: #a45bad;">10</span><span style="color: #4f97d7;">]</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">list</span><span style="color: #bc6ec5;">(</span>dedupe<span style="color: #2d9574;">(</span>a<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
[1, 5, 2, 9, 10]

</pre>
<p>
这个方法仅仅在序列中元素为 hashable 的时候才管用。如果你想消除元素不可哈希（比如 dict 类型）的序列中重复元素，需要将尚需代码修改：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">dedupe</span><span style="color: #4f97d7;">(</span>items, key=<span style="color: #a45bad;">None</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">seen</span> = <span style="color: #4f97d7;">set</span><span style="color: #4f97d7;">()</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> item <span style="color: #4f97d7; font-weight: bold;">in</span> items:
        <span style="color: #7590db;">val</span> = item <span style="color: #4f97d7; font-weight: bold;">if</span> key <span style="color: #4f97d7; font-weight: bold;">is</span> <span style="color: #a45bad;">None</span> <span style="color: #4f97d7; font-weight: bold;">else</span> key<span style="color: #4f97d7;">(</span>item<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> val <span style="color: #4f97d7; font-weight: bold;">not</span> <span style="color: #4f97d7; font-weight: bold;">in</span> seen:
            <span style="color: #4f97d7; font-weight: bold;">yield</span> item
            seen.add<span style="color: #4f97d7;">(</span>val<span style="color: #4f97d7;">)</span>


<span style="color: #7590db;">a</span> = <span style="color: #4f97d7;">[</span><span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'x'</span>: <span style="color: #a45bad;">1</span>, <span style="color: #2d9574;">'y'</span>: <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">}</span>, <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'x'</span>: <span style="color: #a45bad;">1</span>, <span style="color: #2d9574;">'y'</span>: <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">}</span>, <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'x'</span>: <span style="color: #a45bad;">1</span>, <span style="color: #2d9574;">'y'</span>: <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">}</span>, <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'x'</span>: <span style="color: #a45bad;">2</span>, <span style="color: #2d9574;">'y'</span>: <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">}</span><span style="color: #4f97d7;">]</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">list</span><span style="color: #bc6ec5;">(</span>dedupe<span style="color: #2d9574;">(</span>a, key=<span style="color: #4f97d7; font-weight: bold;">lambda</span> d: <span style="color: #67b11d;">(</span>d<span style="color: #b1951d;">[</span><span style="color: #2d9574;">'x'</span><span style="color: #b1951d;">]</span>, d<span style="color: #b1951d;">[</span><span style="color: #2d9574;">'y'</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">list</span><span style="color: #bc6ec5;">(</span>dedupe<span style="color: #2d9574;">(</span>a, key=<span style="color: #4f97d7; font-weight: bold;">lambda</span> d: d<span style="color: #67b11d;">[</span><span style="color: #2d9574;">'x'</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
[{'x': 1, 'y': 2}, {'x': 1, 'y': 3}, {'x': 2, 'y': 4}]
[{'x': 1, 'y': 2}, {'x': 2, 'y': 4}]

</pre>
<p>
使用 set 也可以去重，但是会打乱顺序，上述的 key 参数模仿了 sorted，min，max 等函数。
</p>
</div>
</div>

<div id="outline-container-org08e181a" class="outline-3">
<h3 id="org08e181a">命名切片</h3>
<div class="outline-text-3" id="text-org08e181a">
<p>
程序中出现一大堆已经无法直视的硬编码切片下表，该如何清理代码？假定有一段代码要从一个记录字符串中几个固定位置提取特定的数据字段：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #7590db;">record</span> = <span style="color: #2d9574;">'....................100 .......513.25 ..........'</span>
<span style="color: #7590db;">cost</span> = <span style="color: #4f97d7;">int</span><span style="color: #4f97d7;">(</span>record<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">20</span>:<span style="color: #a45bad;">23</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> * <span style="color: #4f97d7;">float</span><span style="color: #4f97d7;">(</span>record<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">31</span>:<span style="color: #a45bad;">37</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>cost<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">SHARES</span> = <span style="color: #4f97d7;">slice</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">20</span>, <span style="color: #a45bad;">23</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">PRICE</span> = <span style="color: #4f97d7;">slice</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">31</span>, <span style="color: #a45bad;">37</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">cost</span> = <span style="color: #4f97d7;">int</span><span style="color: #4f97d7;">(</span>record<span style="color: #bc6ec5;">[</span>SHARES<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> * <span style="color: #4f97d7;">float</span><span style="color: #4f97d7;">(</span>record<span style="color: #bc6ec5;">[</span>PRICE<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>cost<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
51325.0
51325.0

</pre>
<p>
第二个版本避免了无法理解的赢编码下标，使得代码清晰可读。
</p>
</div>
</div>

<div id="outline-container-org424e6b0" class="outline-3">
<h3 id="org424e6b0">序列中出现次数最多的元素</h3>
<div class="outline-text-3" id="text-org424e6b0">
<p>
怎样找出一个序列中出现次数最多的元素？
collections.Counter 类专门为这类问题而设计的，它甚至有一个有用的 most_common()方法直接给了答案。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> collections <span style="color: #4f97d7; font-weight: bold;">import</span> Counter

<span style="color: #7590db;">words</span> = <span style="color: #4f97d7;">[</span>
    <span style="color: #2d9574;">'look'</span>, <span style="color: #2d9574;">'into'</span>, <span style="color: #2d9574;">'my'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">'look'</span>, <span style="color: #2d9574;">'into'</span>, <span style="color: #2d9574;">'my'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">'the'</span>, <span style="color: #2d9574;">'eyes'</span>,
    <span style="color: #2d9574;">'the'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">'the'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">'not'</span>, <span style="color: #2d9574;">'around'</span>, <span style="color: #2d9574;">'the'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">"don't"</span>,
    <span style="color: #2d9574;">'look'</span>, <span style="color: #2d9574;">'around'</span>, <span style="color: #2d9574;">'the'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">'look'</span>, <span style="color: #2d9574;">'into'</span>, <span style="color: #2d9574;">'my'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">"you're"</span>,
    <span style="color: #2d9574;">'under'</span>
<span style="color: #4f97d7;">]</span>

<span style="color: #7590db;">word_counts</span> = Counter<span style="color: #4f97d7;">(</span>words<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">top_three</span> = word_counts.most_common<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">3</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>top_three<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
[('eyes', 8), ('the', 5), ('look', 4)]

</pre>
<p>
Counter 类的注释写着：Dict subclass for counting hashable items. Elements are stored as
dictionary keys and their counts are stored as dictionary values.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> collections <span style="color: #4f97d7; font-weight: bold;">import</span> Counter

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">count elements from a string, create Counter instance from string.</span>
<span style="color: #7590db;">c</span> = Counter<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'abcdeabcdabcaba'</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>c<span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">three most common elements</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>c.most_common<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">list all unique elements</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">sorted</span><span style="color: #bc6ec5;">(</span>c<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">list elements with repetitions</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">''</span>.join<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7;">sorted</span><span style="color: #2d9574;">(</span>c.elements<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">total of all counts</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">sum</span><span style="color: #bc6ec5;">(</span>c.values<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>


<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>c<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'a'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">update counts from an iterable</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> elem <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #2d9574;">'shazam'</span>:
    <span style="color: #7590db;">c</span><span style="color: #4f97d7;">[</span>elem<span style="color: #4f97d7;">]</span> += <span style="color: #a45bad;">1</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>c<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'a'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">remove all 'b'</span>
<span style="color: #4f97d7; font-weight: bold;">del</span> c<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'b'</span><span style="color: #4f97d7;">]</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>c<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'b'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Counter({'a': 5, 'b': 4, 'c': 3, 'd': 2, 'e': 1})
[('a', 5), ('b', 4), ('c', 3)]
['a', 'b', 'c', 'd', 'e']
aaaaabbbbcccdde
15
5
7
0

</pre>

<p>
Counter instance 可以很容易跟数学运算操作相结合。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> collections  <span style="color: #4f97d7; font-weight: bold;">import</span> Counter
<span style="color: #7590db;">words</span> = <span style="color: #4f97d7;">[</span>
    <span style="color: #2d9574;">'look'</span>, <span style="color: #2d9574;">'into'</span>, <span style="color: #2d9574;">'my'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">'look'</span>, <span style="color: #2d9574;">'into'</span>, <span style="color: #2d9574;">'my'</span>, <span style="color: #2d9574;">'eyes'</span>,
    <span style="color: #2d9574;">'the'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">'the'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">'the'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">'not'</span>, <span style="color: #2d9574;">'around'</span>, <span style="color: #2d9574;">'the'</span>,
    <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">"don't"</span>, <span style="color: #2d9574;">'look'</span>, <span style="color: #2d9574;">'around'</span>, <span style="color: #2d9574;">'the'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">'look'</span>, <span style="color: #2d9574;">'into'</span>,
    <span style="color: #2d9574;">'my'</span>, <span style="color: #2d9574;">'eyes'</span>, <span style="color: #2d9574;">"you're"</span>, <span style="color: #2d9574;">'under'</span>
<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">morewords</span> = <span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'why'</span>,<span style="color: #2d9574;">'are'</span>,<span style="color: #2d9574;">'you'</span>,<span style="color: #2d9574;">'not'</span>,<span style="color: #2d9574;">'looking'</span>,<span style="color: #2d9574;">'in'</span>,<span style="color: #2d9574;">'my'</span>,<span style="color: #2d9574;">'eyes'</span><span style="color: #4f97d7;">]</span>

<span style="color: #7590db;">a</span> = Counter<span style="color: #4f97d7;">(</span>words<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">b</span> = Counter<span style="color: #4f97d7;">(</span>morewords<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>b<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a + b<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>a - b<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Counter({'eyes': 8, 'the': 5, 'look': 4, 'into': 3, 'my': 3, 'around': 2, 'not': 1, "don't": 1, "you're": 1, 'under': 1})
Counter({'why': 1, 'are': 1, 'you': 1, 'not': 1, 'looking': 1, 'in': 1, 'my': 1, 'eyes': 1})
Counter({'eyes': 9, 'the': 5, 'look': 4, 'my': 4, 'into': 3, 'not': 2, 'around': 2, "don't": 1, "you're": 1, 'under': 1, 'why': 1, 'are': 1, 'you': 1, 'looking': 1, 'in': 1})
Counter({'eyes': 7, 'the': 5, 'look': 4, 'into': 3, 'my': 2, 'around': 2, "don't": 1, "you're": 1, 'under': 1})

</pre>
<p>
Counter 对象在几乎所有需要制表或者计数数据的场合是非常有用的工具。
</p>
</div>
</div>

<div id="outline-container-org4b327cd" class="outline-3">
<h3 id="org4b327cd">通过某个关键字排序一个字典列表</h3>
<div class="outline-text-3" id="text-org4b327cd">
<p>
根据某个或几个字典字段来排序这个列表？通过使用 operator 模块的 itemgetter 函数，可以非常容易的排序这样的数据结构。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> operator <span style="color: #4f97d7; font-weight: bold;">import</span> itemgetter
<span style="color: #4f97d7; font-weight: bold;">from</span> pprint <span style="color: #4f97d7; font-weight: bold;">import</span> pprint

<span style="color: #7590db;">rows</span> = <span style="color: #4f97d7;">[</span>
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'fname'</span>: <span style="color: #2d9574;">'Brian'</span>, <span style="color: #2d9574;">'lname'</span>: <span style="color: #2d9574;">'Jones'</span>, <span style="color: #2d9574;">'uid'</span>: <span style="color: #a45bad;">1003</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'fname'</span>: <span style="color: #2d9574;">'David'</span>, <span style="color: #2d9574;">'lname'</span>: <span style="color: #2d9574;">'Beazley'</span>, <span style="color: #2d9574;">'uid'</span>: <span style="color: #a45bad;">1002</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'fname'</span>: <span style="color: #2d9574;">'John'</span>, <span style="color: #2d9574;">'lname'</span>: <span style="color: #2d9574;">'Cleese'</span>, <span style="color: #2d9574;">'uid'</span>: <span style="color: #a45bad;">1001</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'fname'</span>: <span style="color: #2d9574;">'Big'</span>, <span style="color: #2d9574;">'lname'</span>: <span style="color: #2d9574;">'Jones'</span>, <span style="color: #2d9574;">'uid'</span>: <span style="color: #a45bad;">1004</span><span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">]</span>

<span style="color: #7590db;">rows_by_fname</span> = <span style="color: #4f97d7;">sorted</span><span style="color: #4f97d7;">(</span>rows, key=itemgetter<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'fname'</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">rows_by_uid</span> = <span style="color: #4f97d7;">sorted</span><span style="color: #4f97d7;">(</span>rows, key=itemgetter<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'uid'</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
pprint<span style="color: #4f97d7;">(</span>rows_by_fname<span style="color: #4f97d7;">)</span>
pprint<span style="color: #4f97d7;">(</span>rows_by_uid<span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">itemgetter support multiple keys</span>
<span style="color: #7590db;">rows_by_lfname</span> = <span style="color: #4f97d7;">sorted</span><span style="color: #4f97d7;">(</span>rows, key=itemgetter<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'lname'</span>, <span style="color: #2d9574;">'fname'</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
pprint<span style="color: #4f97d7;">(</span>rows_by_lfname<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
[{'fname': 'Big', 'lname': 'Jones', 'uid': 1004},
 {'fname': 'Brian', 'lname': 'Jones', 'uid': 1003},
 {'fname': 'David', 'lname': 'Beazley', 'uid': 1002},
 {'fname': 'John', 'lname': 'Cleese', 'uid': 1001}]
[{'fname': 'John', 'lname': 'Cleese', 'uid': 1001},
 {'fname': 'David', 'lname': 'Beazley', 'uid': 1002},
 {'fname': 'Brian', 'lname': 'Jones', 'uid': 1003},
 {'fname': 'Big', 'lname': 'Jones', 'uid': 1004}]
[{'fname': 'David', 'lname': 'Beazley', 'uid': 1002},
 {'fname': 'John', 'lname': 'Cleese', 'uid': 1001},
 {'fname': 'Big', 'lname': 'Jones', 'uid': 1004},
 {'fname': 'Brian', 'lname': 'Jones', 'uid': 1003}]
</pre>
<p>
上例中，rows 被传递给接受一个关键字参数（key）的 sorted 内置函数，key 参数是一个 callable 类型，并且从 rows 中接受一个单一元素，然后返回被用来排序的值。
itemgetter()函数就是负责创建这个 callable 对象的。
operator.itemgetter 函数有一个被 rows 中的记录用来查找值的索引参数。可以是一个字典键名称，一个整型值或者任何能够传入一个对象的__getitem__()方法的值。如果你传入多个索引参数给 itemgetter()，它生成的 callable 对象会返回一个包含所有元素值的元组，并且，sorted()函数会根据这个元组中元素顺序去排序。但你想要同时在几个字段上面进行排序这种方法就很有用。当然 itemgetter()有时也可以用 lambda 表达式代替。
</p>
</div>
</div>

<div id="outline-container-org9b198b9" class="outline-3">
<h3 id="org9b198b9">排序不支持原生比较的对象</h3>
<div class="outline-text-3" id="text-org9b198b9">
<p>
如何排序类型相同的对象，但它们不支持原生的比较操作?
内置函数 sorted()有一个关键字参数 key，可以传入一个 callable 对象给它，这个 callable 对象对每个传入的对象返回一个值，这个值会被 sorted 用来排序这些对象
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> operator <span style="color: #4f97d7; font-weight: bold;">import</span> attrgetter


<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">User</span>:
    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">__init__</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, user_id<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">self</span>.user_id = user_id

    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">__repr__</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span><span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">'User({})'</span>.<span style="color: #4f97d7;">format</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>.user_id<span style="color: #4f97d7;">)</span>


<span style="color: #7590db;">users</span> = <span style="color: #4f97d7;">[</span>User<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">23</span><span style="color: #bc6ec5;">)</span>, User<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span>, User<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">99</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">]</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>users<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">sorted</span><span style="color: #bc6ec5;">(</span>users, key=<span style="color: #4f97d7; font-weight: bold;">lambda</span> u: u.user_id<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#36890;&#36807; operator.attrgetter()&#26469;&#20195;&#26367; lambda</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">sorted</span><span style="color: #bc6ec5;">(</span>users, key=attrgetter<span style="color: #2d9574;">(</span><span style="color: #2d9574;">'user_id'</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
[User(23), User(3), User(99)]
[User(3), User(23), User(99)]
[User(3), User(23), User(99)]

</pre>
<p>
选择使用 lambda 还是 attrgetter()都可以，但是 attrgetter()通常会快点，并且还能同时允许多个字段进行比较。这个和 itemgetter()函数功能类似。而且这个 attrgetter()不仅适用于 sorted 排序，对 min、max 之类的函数都适用。
</p>
</div>
</div>

<div id="outline-container-org2ac48bb" class="outline-3">
<h3 id="org2ac48bb">通过某个字段将记录分组</h3>
<div class="outline-text-3" id="text-org2ac48bb">
<p>
你有一个字典或实例的序列，然后想根据某个特定的字段比如 date 来分组迭代访问。
itertools.groupby()函数对于这样的数据分组操作非常实用。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> itertools <span style="color: #4f97d7; font-weight: bold;">import</span> groupby
<span style="color: #4f97d7; font-weight: bold;">from</span> operator <span style="color: #4f97d7; font-weight: bold;">import</span> itemgetter

<span style="color: #7590db;">rows</span> = <span style="color: #4f97d7;">[</span>
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'5412 N CLARK'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/01/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'5148 N CLARK'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/04/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'5800 E 58TH'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/02/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'2122 N CLARK'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/03/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'5645 N RAVENSWOOD'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/02/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'1060 W ADDISON'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/02/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'4801 N BROADWAY'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/01/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'1039 W GRANVILLE'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/04/2012'</span><span style="color: #bc6ec5;">}</span>,
<span style="color: #4f97d7;">]</span>

rows.sort<span style="color: #4f97d7;">(</span>key=itemgetter<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'date'</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> date, items <span style="color: #4f97d7; font-weight: bold;">in</span> groupby<span style="color: #4f97d7;">(</span>rows, key=itemgetter<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'date'</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>date<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> items:
        <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">' '</span>, i<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
07/01/2012
  {'address': '5412 N CLARK', 'date': '07/01/2012'}
  {'address': '4801 N BROADWAY', 'date': '07/01/2012'}
07/02/2012
  {'address': '5800 E 58TH', 'date': '07/02/2012'}
  {'address': '5645 N RAVENSWOOD', 'date': '07/02/2012'}
  {'address': '1060 W ADDISON', 'date': '07/02/2012'}
07/03/2012
  {'address': '2122 N CLARK', 'date': '07/03/2012'}
07/04/2012
  {'address': '5148 N CLARK', 'date': '07/04/2012'}
  {'address': '1039 W GRANVILLE', 'date': '07/04/2012'}
</pre>
<p>
groupby()函数扫描整个序列并且连续相同值（或者根据指定 key 函数返回值相同）的元素序列。在每次迭代的时候，它会返回一个值和一个迭代对象，这个迭代对象可以生成元素值全部等于上面那个值中所有对象。一个非常重要的步骤是要根据指定的字段将数据排序。因为 groupby()仅仅检查连续的元素，如果事先并没有排序完成的话，分组函数将得不到想要的数据。如果仅仅只想根据 date 字段将数据分组到一个大的数据结构中，并且允许随机访问，最好用 collections.defaultdict()
来构建一个多值字典。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> collections <span style="color: #4f97d7; font-weight: bold;">import</span> defaultdict
<span style="color: #4f97d7; font-weight: bold;">from</span> pprint <span style="color: #4f97d7; font-weight: bold;">import</span> pprint

<span style="color: #7590db;">rows</span> = <span style="color: #4f97d7;">[</span>
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'5412 N CLARK'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/01/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'5148 N CLARK'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/04/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'5800 E 58TH'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/02/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'2122 N CLARK'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/03/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'5645 N RAVENSWOOD'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/02/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'1060 W ADDISON'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/02/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'4801 N BROADWAY'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/01/2012'</span><span style="color: #bc6ec5;">}</span>,
    <span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'address'</span>: <span style="color: #2d9574;">'1039 W GRANVILLE'</span>, <span style="color: #2d9574;">'date'</span>: <span style="color: #2d9574;">'07/04/2012'</span><span style="color: #bc6ec5;">}</span>,
<span style="color: #4f97d7;">]</span>

<span style="color: #7590db;">rows_by_date</span> = defaultdict<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">list</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> row <span style="color: #4f97d7; font-weight: bold;">in</span> rows:
    rows_by_date<span style="color: #4f97d7;">[</span>row<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'date'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">]</span>.append<span style="color: #4f97d7;">(</span>row<span style="color: #4f97d7;">)</span>

pprint<span style="color: #4f97d7;">(</span>rows_by_date<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
defaultdict(&lt;class 'list'&gt;,
            {'07/01/2012': [{'address': '5412 N CLARK', 'date': '07/01/2012'},
                            {'address': '4801 N BROADWAY',
                             'date': '07/01/2012'}],
             '07/02/2012': [{'address': '5800 E 58TH', 'date': '07/02/2012'},
                            {'address': '5645 N RAVENSWOOD',
                             'date': '07/02/2012'},
                            {'address': '1060 W ADDISON',
                             'date': '07/02/2012'}],
             '07/03/2012': [{'address': '2122 N CLARK', 'date': '07/03/2012'}],
             '07/04/2012': [{'address': '5148 N CLARK', 'date': '07/04/2012'},
                            {'address': '1039 W GRANVILLE',
                             'date': '07/04/2012'}]})
</pre>
<p>
如果不考虑内存占用情况，这用方法比 groupby()函数迭代运行更快。
</p>
</div>
</div>

<div id="outline-container-org355068e" class="outline-3">
<h3 id="org355068e">过滤序列元素</h3>
<div class="outline-text-3" id="text-org355068e">
<p>
有一个数据序列，想利用一些规则从中提取出需要的值或者是缩短序列？最简单的过滤列表元素的方法就是适用列表推导式。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #7590db;">mylist</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">4</span>, -<span style="color: #a45bad;">5</span>, <span style="color: #a45bad;">10</span>, -<span style="color: #a45bad;">7</span>, <span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">3</span>, -<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>n <span style="color: #4f97d7; font-weight: bold;">for</span> n <span style="color: #4f97d7; font-weight: bold;">in</span> mylist <span style="color: #4f97d7; font-weight: bold;">if</span> n &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">pos</span> = <span style="color: #4f97d7;">(</span>n <span style="color: #4f97d7; font-weight: bold;">for</span> n <span style="color: #4f97d7; font-weight: bold;">in</span> mylist <span style="color: #4f97d7; font-weight: bold;">if</span> n &gt; <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>pos<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
[1, 4, 10, 2, 3]
&lt;generator object &lt;genexpr&gt; at 0x7f4910bf9c50&gt;

</pre>
<p>
适用列表推导式的一个潜在缺陷是如果输入非常大的时候会产生一个非常大的结果集，占用大量内存。如果对内存有要求，可以适用生成器表达式来过滤元素。就如上例中第二中方法。有时候过滤规则比较复杂，不能简单的在列表推导或者生成器表达式中表达出来。比如，在过滤时需要处理一些异常或者其复杂情况，这时需要将过滤代码放入一个函数，然后调用内置函数 filter()。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #7590db;">values</span> = <span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'1'</span>, <span style="color: #2d9574;">'2'</span>, <span style="color: #2d9574;">'-3'</span>, <span style="color: #2d9574;">'-'</span>, <span style="color: #2d9574;">'4'</span>, <span style="color: #2d9574;">'N/A'</span>, <span style="color: #2d9574;">'5'</span><span style="color: #4f97d7;">]</span>


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">is_int</span><span style="color: #4f97d7;">(</span>val<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">try</span>:
        <span style="color: #4f97d7;">int</span><span style="color: #4f97d7;">(</span>val<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">True</span>
    <span style="color: #4f97d7; font-weight: bold;">except</span> <span style="color: #ce537a; font-weight: bold;">ValueError</span>:
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">False</span>


<span style="color: #7590db;">ivals</span> = <span style="color: #4f97d7;">list</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">filter</span><span style="color: #bc6ec5;">(</span>is_int, values<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>ivals<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
['1', '2', '-3', '4', '5']

</pre>
<p>
列表推导和生成器表达式通常情况下是过滤数据最简单的方式，当然在过滤数据时也可以转换数据。过滤操作的一个变种就是将不符合条件的值用新的值来代替，而不是丢弃它们。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #7590db;">mylist</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">4</span>, -<span style="color: #a45bad;">5</span>, <span style="color: #a45bad;">10</span>, -<span style="color: #a45bad;">7</span>, <span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">3</span>, -<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">clip_neg</span> = <span style="color: #4f97d7;">[</span>n <span style="color: #4f97d7; font-weight: bold;">if</span> n &gt; <span style="color: #a45bad;">0</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #a45bad;">0</span> <span style="color: #4f97d7; font-weight: bold;">for</span> n <span style="color: #4f97d7; font-weight: bold;">in</span> mylist<span style="color: #4f97d7;">]</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>clip_neg<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">clip_pos</span> = <span style="color: #4f97d7;">[</span>n <span style="color: #4f97d7; font-weight: bold;">if</span> n &lt; <span style="color: #a45bad;">0</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #a45bad;">0</span> <span style="color: #4f97d7; font-weight: bold;">for</span> n <span style="color: #4f97d7; font-weight: bold;">in</span> mylist<span style="color: #4f97d7;">]</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>clip_pos<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
[1, 4, 0, 10, 0, 2, 3, 0]
[0, 0, -5, 0, -7, 0, 0, -1]

</pre>
</div>
</div>
</div>

<div id="outline-container-orge222deb" class="outline-2">
<h2 id="orge222deb">文本与 IO</h2>
</div>
<div id="outline-container-org3dc8150" class="outline-2">
<h2 id="org3dc8150">数据编码和处理</h2>
</div>

<div id="outline-container-org0b6d568" class="outline-2">
<h2 id="org0b6d568">函数</h2>
</div>

<div id="outline-container-org5377ac1" class="outline-2">
<h2 id="org5377ac1">类与对象</h2>
</div>
<div id="outline-container-orgb2c42f9" class="outline-2">
<h2 id="orgb2c42f9">元编程</h2>
<div class="outline-text-2" id="text-orgb2c42f9">
</div>
<div id="outline-container-org1ae4532" class="outline-3">
<h3 id="org1ae4532">在函数上添加包装器</h3>
<div class="outline-text-3" id="text-org1ae4532">
<p>
如何在函数上添加一个包装器，增加额外的操作处理，比如日志，计时等？适用装饰器即可完成
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> time
<span style="color: #4f97d7; font-weight: bold;">from</span> functools <span style="color: #4f97d7; font-weight: bold;">import</span> wraps


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">timethis</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">"""</span>
<span style="color: #2aa1ae;">    Decorator that reports the execution time.</span>
<span style="color: #2aa1ae;">    """</span>

    <span style="color: #ce537a; font-weight: bold;">@wraps</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">wrapper</span><span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>:
        <span style="color: #7590db;">start</span> = time.time<span style="color: #4f97d7;">()</span>
        <span style="color: #7590db;">result</span> = func<span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>
        <span style="color: #7590db;">end</span> = time.time<span style="color: #4f97d7;">()</span>
        <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>func.<span style="color: #4f97d7;">__name__</span>, end - start<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> result

    <span style="color: #4f97d7; font-weight: bold;">return</span> wrapper


<span style="color: #ce537a; font-weight: bold;">@timethis</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">countdown</span><span style="color: #4f97d7;">(</span>n<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">'''</span>
<span style="color: #2aa1ae;">    Counts down</span>
<span style="color: #2aa1ae;">    '''</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> n &gt; <span style="color: #a45bad;">0</span>:
        <span style="color: #7590db;">n</span> -= <span style="color: #a45bad;">1</span>


countdown<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">100000</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
countdown 0.0041043758392333984

</pre>
<p>
一个装饰器就是一个函数，它接受一个函数作为参数并返回一个新的函数。内置装饰器@staticmethod,@classmethod,@property,@wraps
原理都是一样。在上面 wrapper()函数中，装饰器内部定义了一个使用*args 和**kwargs 来接受任意参数的函数。在这个函数里调用原始函数并将其结果返回，不过还可以添加其他额外的代码，这个新的函数包装器被作为结果返回来替代原始函数。需要强调的是装饰器并不会修改原始函数的参数签名以及返回值。使用*args 和**kwargs 目的就是确保任何参数都能适用，而返回结果值节本都是调用原始函数 func(*args, **kwargs)的返回结果，其中 func 就是原始函数。
@wraps(func)注释很重要，它能保留原始函数的元数据。
</p>
</div>
</div>
<div id="outline-container-orgb1cc8ee" class="outline-3">
<h3 id="orgb1cc8ee">创建装饰器时保留函数元信息</h3>
<div class="outline-text-3" id="text-orgb1cc8ee">
<p>
写一个装饰器作用在函数上，但是这个函数的重要的元信息比如名字，文档字符串，注释和参数签名都丢失了。任何时候定义装饰器时都应该使用 functools 中的@wraps 装饰器来注解底层包装函数。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> time
<span style="color: #4f97d7; font-weight: bold;">from</span> functools <span style="color: #4f97d7; font-weight: bold;">import</span> wraps


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">timethis</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">'''</span>
<span style="color: #2aa1ae;">    Decorator that reports the execution time.</span>
<span style="color: #2aa1ae;">    '''</span>

    <span style="color: #ce537a; font-weight: bold;">@wraps</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">wrapper</span><span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>:
        <span style="color: #7590db;">start</span> = time.time<span style="color: #4f97d7;">()</span>
        <span style="color: #7590db;">result</span> = func<span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>
        <span style="color: #7590db;">end</span> = time.time<span style="color: #4f97d7;">()</span>
        <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>func.<span style="color: #4f97d7;">__name__</span>, end - start<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> result

    <span style="color: #4f97d7; font-weight: bold;">return</span> wrapper


<span style="color: #ce537a; font-weight: bold;">@timethis</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">countdown</span><span style="color: #4f97d7;">(</span>n:<span style="color: #4f97d7;">int</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">'''</span>
<span style="color: #2aa1ae;">    Counts down</span>
<span style="color: #2aa1ae;">    '''</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> n &gt; <span style="color: #a45bad;">0</span>:
        <span style="color: #7590db;">n</span> -= <span style="color: #a45bad;">1</span>


countdown<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">100000</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>countdown.<span style="color: #4f97d7;">__name__</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>countdown.<span style="color: #4f97d7;">__doc__</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>countdown.__annotations__<span style="color: #4f97d7;">)</span>


countdown.__wrapped__<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">100000</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">from</span> inspect <span style="color: #4f97d7; font-weight: bold;">import</span> signature
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>signature<span style="color: #bc6ec5;">(</span>countdown<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
countdown 0.004173994064331055
countdown

    Counts down
    
{'n': &lt;class 'int'&gt;}
(n:int)

</pre>
<p>
在编写装饰器的时候复制元信息时一个非常重要的部分。@wraps 的一个重要特征时通过属性__wrapped__直接访问被包装函数。
__wrapped__属性还能让被装饰函数正确暴露底层的参数签名信息。一个很普通的问题是怎样让装饰器去直接复制函数的参数签名信息，如果想自己手动实现需要大量工作，直接适用@wraps，通过底层的__wrapped__属性访问到函数签名信息。
</p>
</div>
</div>
<div id="outline-container-org54ab9b6" class="outline-3">
<h3 id="org54ab9b6">解除一个装饰器</h3>
<div class="outline-text-3" id="text-org54ab9b6">
<p>
一个装饰器已经作用在一个函数上，如何撤销它，直接访问原始的未包装的那个函数。假设装饰器时通过@wraps 来实现的，那么可以通过访问__wrapped__属性来访问原始函数直接访问未包装的原始函数在调试、内省和其他函数操作时时很有用的。但是这里的方案仅仅适用与在包装器中正确适用了@wrapper 或者直接设置了__wrapped__属性的情况。如果有多个包装器，那么访问__wrapped__属性的行为时不可预知的，应该避免这样做。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">from</span> functools <span style="color: #4f97d7; font-weight: bold;">import</span> wraps


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">decorator1</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>:
    <span style="color: #ce537a; font-weight: bold;">@wraps</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">wrapper</span><span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Decorator 1'</span><span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> func<span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> wrapper


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">decorator2</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>:
    <span style="color: #ce537a; font-weight: bold;">@wraps</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">wrapper</span><span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Decorator 2'</span><span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> func<span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> wrapper


<span style="color: #ce537a; font-weight: bold;">@decorator1</span>
<span style="color: #ce537a; font-weight: bold;">@decorator2</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">add</span><span style="color: #4f97d7;">(</span>x, y<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> x + y


<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>add<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>add.__wrapped__<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Decorator 1
Decorator 2
5
Decorator 2
5

</pre>
<p>
可以看出在 python3.4 以上，适用__wrapped__直接调用函数时无效的，而且并不是所有的装饰器都适用了@wraps，特别的，内置的装饰器@staticmethod 和@classmethod 就没有遵循这个约定（它们把原始函数存储在属性__func__中）。
</p>
</div>
</div>
<div id="outline-container-org3c50dea" class="outline-3">
<h3 id="org3c50dea">定义一个带参数的装饰器</h3>
<div class="outline-text-3" id="text-org3c50dea">
<p>
如何定一个带参数的装饰器?
用一个例子来详细阐述接受参数的处理过程。假设想写一个装饰器给函数添加日志功能，同时允许用户指定日志级别和其他的选项。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> logging
<span style="color: #4f97d7; font-weight: bold;">from</span> functools <span style="color: #4f97d7; font-weight: bold;">import</span> wraps


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">logged</span><span style="color: #4f97d7;">(</span>level, name=<span style="color: #a45bad;">None</span>, message=<span style="color: #a45bad;">None</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">"""</span>
<span style="color: #2aa1ae;">    Add logging to a function, level is the logging</span>
<span style="color: #2aa1ae;">    level, name is the logger name, and message is the log</span>
<span style="color: #2aa1ae;">    message. If name and message aren't specified they default</span>
<span style="color: #2aa1ae;">    to the function's module and name.</span>
<span style="color: #2aa1ae;">    """</span>

    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">decorate</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>:
        <span style="color: #7590db;">logname</span> = name <span style="color: #4f97d7; font-weight: bold;">if</span> name <span style="color: #4f97d7; font-weight: bold;">else</span> func.__module__
        <span style="color: #7590db;">log</span> = logging.getLogger<span style="color: #4f97d7;">(</span>logname<span style="color: #4f97d7;">)</span>
        <span style="color: #7590db;">logmsg</span> = message <span style="color: #4f97d7; font-weight: bold;">if</span> message <span style="color: #4f97d7; font-weight: bold;">else</span> func.<span style="color: #4f97d7;">__name__</span>

        <span style="color: #ce537a; font-weight: bold;">@wraps</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">wrapper</span><span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>:
            <span style="color: #4f97d7; font-weight: bold;">try</span>:
                <span style="color: #4f97d7; font-weight: bold;">return</span> func<span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>
            <span style="color: #4f97d7; font-weight: bold;">except</span> <span style="color: #ce537a; font-weight: bold;">TypeError</span>:
                log.log<span style="color: #4f97d7;">(</span>level, logmsg<span style="color: #4f97d7;">)</span>

        <span style="color: #4f97d7; font-weight: bold;">return</span> wrapper

    <span style="color: #4f97d7; font-weight: bold;">return</span> decorate


<span style="color: #ce537a; font-weight: bold;">@logged</span><span style="color: #4f97d7;">(</span>logging.DEBUG<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">add</span><span style="color: #4f97d7;">(</span>x, y<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> x + y


<span style="color: #ce537a; font-weight: bold;">@logged</span><span style="color: #4f97d7;">(</span>logging.CRITICAL, <span style="color: #2d9574;">'example'</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">spam</span><span style="color: #4f97d7;">()</span>:
    <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Spam!'</span><span style="color: #4f97d7;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org963262d" class="outline-3">
<h3 id="org963262d">可自定义属性的装饰器</h3>
<div class="outline-text-3" id="text-org963262d">
<p>
写一个装饰器来包装一个函数，并且允许用户提供参数在运行时控制装饰器行为？引入一个访问函数，适用 nonlocal 来修改内部变量，然后这个访问函数被作为一个属性赋值给包装函数。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> logging

<span style="color: #4f97d7; font-weight: bold;">from</span> functools <span style="color: #4f97d7; font-weight: bold;">import</span> partial, wraps


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">attach_wrapper</span><span style="color: #4f97d7;">(</span>obj, func=<span style="color: #a45bad;">None</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">if</span> func <span style="color: #4f97d7; font-weight: bold;">is</span> <span style="color: #a45bad;">None</span>:
        <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'---------'</span><span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> partial<span style="color: #4f97d7;">(</span>attach_wrapper, obj<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7;">setattr</span><span style="color: #4f97d7;">(</span>obj, func.<span style="color: #4f97d7;">__name__</span>, func<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"+++++++++++"</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> func


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">logged</span><span style="color: #4f97d7;">(</span>level, name=<span style="color: #a45bad;">None</span>, message=<span style="color: #a45bad;">None</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">'''</span>
<span style="color: #2aa1ae;">    Add logging to a function. level is the logging</span>
<span style="color: #2aa1ae;">    level, name is the logger name, and message is the</span>
<span style="color: #2aa1ae;">    log messagel If name and message aren't specified,</span>
<span style="color: #2aa1ae;">    they default to the function's module and name.</span>
<span style="color: #2aa1ae;">    '''</span>

    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">decorate</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>:
        <span style="color: #7590db;">logname</span> = name <span style="color: #4f97d7; font-weight: bold;">if</span> name <span style="color: #4f97d7; font-weight: bold;">else</span> func.__module__
        <span style="color: #7590db;">log</span> = logging.getLogger<span style="color: #4f97d7;">(</span>logname<span style="color: #4f97d7;">)</span>
        <span style="color: #7590db;">logmsg</span> = message <span style="color: #4f97d7; font-weight: bold;">if</span> message <span style="color: #4f97d7; font-weight: bold;">else</span> func.<span style="color: #4f97d7;">__name__</span>

        <span style="color: #ce537a; font-weight: bold;">@wraps</span><span style="color: #4f97d7;">(</span>func<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">wrapper</span><span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>:
            log.log<span style="color: #4f97d7;">(</span>level, logmsg<span style="color: #4f97d7;">)</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> func<span style="color: #4f97d7;">(</span>*args, **kwargs<span style="color: #4f97d7;">)</span>

        <span style="color: #ce537a; font-weight: bold;">@attach_wrapper</span><span style="color: #4f97d7;">(</span>wrapper<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">set_level</span><span style="color: #4f97d7;">(</span>newlevel<span style="color: #4f97d7;">)</span>:
            <span style="color: #4f97d7; font-weight: bold;">nonlocal</span> level
            <span style="color: #7590db;">level</span> = newlevel

        <span style="color: #ce537a; font-weight: bold;">@attach_wrapper</span><span style="color: #4f97d7;">(</span>wrapper<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">set_message</span><span style="color: #4f97d7;">(</span>newmsg<span style="color: #4f97d7;">)</span>:
            <span style="color: #4f97d7; font-weight: bold;">nonlocal</span> logmsg
            <span style="color: #7590db;">logmsg</span> = newmsg

        <span style="color: #4f97d7; font-weight: bold;">return</span> wrapper

    <span style="color: #4f97d7; font-weight: bold;">return</span> decorate


<span style="color: #ce537a; font-weight: bold;">@logged</span><span style="color: #4f97d7;">(</span>logging.DEBUG<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">add</span><span style="color: #4f97d7;">(</span>x, y<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> x + y


<span style="color: #ce537a; font-weight: bold;">@logged</span><span style="color: #4f97d7;">(</span>logging.CRITICAL, <span style="color: #2d9574;">'example'</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">spam</span><span style="color: #4f97d7;">()</span>:
    <span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Spam'</span><span style="color: #4f97d7;">)</span>


logging.basicConfig<span style="color: #4f97d7;">(</span>level=logging.DEBUG<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>add<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

add.set_message<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Add called'</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>add<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

add.set_level<span style="color: #4f97d7;">(</span>logging.WARNING<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">print</span><span style="color: #4f97d7;">(</span>add<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
---------
+++++++++++
---------
+++++++++++
---------
+++++++++++
---------
+++++++++++
5
5
5
</pre>
</div>
</div>
</div>

<div id="outline-container-org013f137" class="outline-2">
<h2 id="org013f137">模块与包</h2>
</div>

<div id="outline-container-org15592bd" class="outline-2">
<h2 id="org15592bd">网络与 web 编程</h2>
</div>

<div id="outline-container-org6f1a438" class="outline-2">
<h2 id="org6f1a438">并发编程</h2>
</div>

<div id="outline-container-org7f086ae" class="outline-2">
<h2 id="org7f086ae">脚本编程与系统管理</h2>
</div>

<div id="outline-container-org59d38d5" class="outline-2">
<h2 id="org59d38d5">测试、调试和异常</h2>
</div>

<div id="outline-container-orgcaff163" class="outline-2">
<h2 id="orgcaff163">C 语言扩展</h2>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2018-01-15 一 16:28</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
